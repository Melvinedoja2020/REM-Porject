{% extends 'dashboard_base.html' %}
{% load static %}
{% block content %}

<!-- main-content -->
<div class="main-content">
  <div class="main-content-inner">
    <div class="main-content-wrap">

      <!-- Header Section -->
      <div class="flex items-center flex-wrap justify-between gap20 mb-27">
        <div>
          <h3 class="modern-title">Messages</h3>
          <p class="modern-subtitle">View and manage your conversations</p>
        </div>

        <div class="table-controls">
          <div class="search-box">
            <i class="icon-search"></i>
            <input type="text" placeholder="Search messages...">
          </div>

          <a href="{% url 'notification:send_message' %}" class="btn-primary">
            <i class="icon-plus"></i> New Message
          </a>
        </div>
      </div>

      <!-- Modern Table -->
      <div class="modern-table-container">
        <div class="wg-box modern-table-wrapper">
          <div class="wg-table table-product-list modern-table">

            <!-- Table Header -->
            <div class="table-header modern-header flex gap20">
              <div class="header-col property-col">
                <div class="body-title">Sender / Receiver</div>
              </div>
              <div class="header-col">
                <div class="body-title">Subject</div>
              </div>
              <div class="header-col">
                <div class="body-title">Message</div>
              </div>
              <div class="header-col">
                <div class="body-title">Date</div>
              </div>
              <div class="header-col actions-col">
                <div class="body-title">Actions</div>
              </div>
            </div>

            <!-- Table Body -->
            <div class="table-body modern-body">
              {% for message in messages %}
              <div class="table-row modern-row flex items-center {% if not message.is_read and message.receiver == request.user %}unread-row{% endif %}">

                <!-- Sender/Receiver -->
                <div class="table-col property-col">
                  <div class="property-info-cell">
                    <div class="property-image">
                      {% if message.sender.agent_profile %}
                        <img src="{{ message.sender.agent_profile.get_profile_picture }}" alt="{{ message.sender.name }}">
                      {% else %}
                        <img src="{{ message.sender.profile.get_profile_picture }}" alt="{{ message.sender.name }}">
                      {% endif %}
                      {% if not message.is_read and message.receiver == request.user %}
                      <div class="featured-badge"><i class="icon-mail"></i></div>
                      {% endif %}
                    </div>
                    <div class="property-details">
                      {% if message.sender == request.user %}
                        <a href="{% url 'notification:message_detail' message.pk %}" class="property-title">
                          To: {{ message.receiver.name|default:message.receiver.username }}
                        </a>
                      {% else %}
                        <a href="{% url 'notification:message_detail' message.pk %}" class="property-title">
                          From: {{ message.sender.name|default:message.sender.username }}
                        </a>
                      {% endif %}

                      {% if message.sender.agent_profile %}
                        <div class="property-location">
                          <i class="icon-user"></i> Agent
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <!-- Subject -->
                <div class="table-col">
                  <div class="price-cell">
                    <span class="price-value">{{ message.subject|default:"(No subject)"|truncatechars:40 }}</span>
                  </div>
                </div>

                <!-- Message Snippet -->
                <div class="table-col">
                  <div class="price-cell">
                    <span class="price-value text-muted">{{ message.message|truncatechars:70 }}</span>
                  </div>
                </div>

                <!-- Date -->
                <div class="table-col">
                  <div class="type-cell">
                    <span class="type-badge">{{ message.created_at|date:"M d, Y h:i A" }}</span>
                  </div>
                </div>

                <!-- Actions -->
                <div class="table-col actions-col">
                  <div class="actions-cell">
                    <!-- View -->
                    <a href="{% url 'notification:message_detail' message.pk %}" class="action-btn view" title="View Message">
                      <i class="icon-eye"></i>
                    </a>

                    <!-- Mark as Read -->
                    {% if not message.is_read and message.receiver == request.user %}
                    <form action="{% url 'notification:mark_message_read' message.pk %}" method="post" class="action-form">
                      {% csrf_token %}
                      <button type="submit" class="action-btn edit" title="Mark as Read">
                        <i class="icon-check"></i>
                      </button>
                    </form>
                    {% endif %}

                    <!-- Delete -->
                    <form action="{% url 'notification:message_delete' message.pk %}" method="post" class="action-form">
                      {% csrf_token %}
                      <button type="submit" class="action-btn delete" title="Delete Message">
                        <i class="icon-trash-2"></i>
                      </button>
                    </form>
                  </div>
                </div>
              </div>
              {% empty %}
              <!-- Empty State -->
              <div class="empty-table-state">
                <div class="empty-icon">
                  <i class="icon-mail"></i>
                </div>
                <h4>No Messages Found</h4>
                <p>You don’t have any messages yet.</p>
                <a href="{% url 'notification:send_message' %}" class="btn-primary">
                  <i class="icon-plus"></i> Start a Conversation
                </a>
              </div>
              {% endfor %}
            </div>
          </div>

          <div class="table-divider"></div>

          <!-- Pagination -->
          {% if is_paginated %}
          <div class="table-footer flex items-center justify-between flex-wrap gap10">
            <div class="pagination-info">
              Showing <strong>{{ page_obj.start_index }}</strong> - <strong>{{ page_obj.end_index }}</strong>
              of <strong>{{ page_obj.paginator.count }}</strong> messages
            </div>
            <ul class="wg-pagination modern-pagination">
              {% if page_obj.has_previous %}
                <li><a href="?page={{ page_obj.previous_page_number }}" class="pagination-nav"><i class="icon-chevron-left"></i></a></li>
              {% endif %}
              {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                  <li><a href="?page={{ num }}" class="pagination-page active">{{ num }}</a></li>
                {% else %}
                  <li><a href="?page={{ num }}" class="pagination-page">{{ num }}</a></li>
                {% endif %}
              {% endfor %}
              {% if page_obj.has_next %}
                <li><a href="?page={{ page_obj.next_page_number }}" class="pagination-nav"><i class="icon-chevron-right"></i></a></li>
              {% endif %}
            </ul>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- bottom-page -->
  {% comment %} <div class="bottom-page">
    <div class="body-text">Copyright © 2025 REM. Design with</div>
    <i class="icon-heart"></i>
    <div class="body-text">
      by <a href="#">REM</a> All rights reserved.
    </div>
  </div> {% endcomment %}
</div>
<!-- /main-content -->

{% endblock %}
