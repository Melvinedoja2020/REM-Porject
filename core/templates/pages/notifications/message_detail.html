{% extends "base.html" %}

<style>
    :root {
        --brand-color: #E8960F;
        --brand-color-hover: #cf830e;
    }

    .btn-brand {
        background-color: var(--brand-color);
        color: white;
        border: none;
    }

    .btn-brand:hover {
        background-color: var(--brand-color-hover);
    }

    .badge-agent {
        background-color: var(--brand-color);
        color: white;
    }

    .badge-you {
        background-color: #198754;
        color: white;
    }

    .chat-right .chat-bubble {
        background-color: var(--brand-color);
        color: white;
    }

    .chat-bubble {
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .transparent-bg {
        background-color: transparent !important;
    }

    .property-card-img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 0.5rem;
    }

    .message-avatar {
        width: 48px;
        height: 48px;
        object-fit: cover;
    }
</style>

{% block content %}
<div class="container py-4 message-detail-container">
    <div class="transparent-bg">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h5">
                <i class="bi bi-envelope me-2 text-primary"></i>Message Details
            </h2>
            <a href="{% url 'notification:message_list' %}" class="btn btn-sm btn-brand">
                <i class="bi bi-arrow-left me-1"></i>Back to Inbox
            </a>
        </div>

        <!-- Display error messages (if any) -->
        {% if messages %}
            <div class="alert alert-danger">
                {% for message in messages %}
                    <p>{{ message }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Main Message -->
        <div class="mb-5">
            <div class="d-flex align-items-start mb-3">
                <img src="{% if message.sender.agent_profile %}{{ message.sender.agent_profile.get_profile_picture }}{% else %}{{ message.sender.profile.get_profile_picture }}{% endif %}"
                     alt="{{ message.sender.name }}"
                     class="rounded-circle message-avatar me-3">
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h5 class="mb-0">
                            {{ message.sender.name|default:message.sender.username }}
                            {% if message.sender.agent_profile %}
                            <span class="badge badge-agent ms-2">Agent</span>
                            {% endif %}
                        </h5>
                        <small class="text-muted">{{ message.created_at|date:"M j, Y H:i" }}</small>
                    </div>
                    <p class="text-muted mb-2">to {{ message.receiver.name|default:message.receiver.username }}</p>
                    <h6 class="mb-3 fw-semibold">{{ message.subject|default:"No subject" }}</h6>
                    <div class="chat-bubble chat-left">
                        {{ message.message|linebreaks }}
                    </div>
                </div>
            </div>

            {% if message.property %}
            <div class="mt-3">
                <div class="row g-2">
                    <div class="col-4">
                        <img src="{{ message.property.images.first.image.url|default:'/static/images/default-property.jpg' }}"
                             class="property-card-img"
                             alt="{{ message.property.title }}">
                    </div>
                    <div class="col-8">
                        <h6 class="mb-1">{{ message.property.title }}</h6>
                        <p class="text-muted small mb-1">
                            <i class="bi bi-geo-alt"></i> {{ message.property.address }}
                        </p>
                        <p class="mb-0">
                            <strong>${{ message.property.price }}</strong>
                            <span class="text-muted small ms-2">{{ message.property.get_property_type_display }}</span>
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Replies Section -->
        {% if replies %}
        <h5 class="mb-3"><i class="bi bi-chat-left-text me-2"></i>Conversation</h5>
        {% for reply in replies %}
        <div class="d-flex mb-4 {% if reply.sender == request.user %}justify-content-end chat-right{% else %}justify-content-start chat-left{% endif %}">
            <div class="d-flex flex-column {% if reply.sender == request.user %}align-items-end text-end{% endif %}">
                <div class="d-flex align-items-center mb-1 {% if reply.sender == request.user %}flex-row-reverse{% endif %}">
                    <img src="{% if reply.sender.agent_profile %}{{ reply.sender.agent_profile.get_profile_picture }}{% else %}{{ reply.sender.profile.get_profile_picture }}{% endif %}"
                         alt="{{ reply.sender.name }}"
                         class="rounded-circle message-avatar {% if reply.sender == request.user %}ms-2{% else %}me-2{% endif %}">
                    <div>
                        <strong>{{ reply.sender.name|default:reply.sender.username }}</strong>
                        {% if reply.sender == request.user %}
                        <span class="badge badge-you ms-1">You</span>
                        {% elif reply.sender.agent_profile %}
                        <span class="badge badge-agent ms-1">Agent</span>
                        {% endif %}
                        <div class="chat-meta">{{ reply.created_at|date:"M j, Y H:i" }}</div>
                    </div>
                </div>
                <div class="chat-bubble {% if reply.sender == request.user %}bg-primary text-white{% else %}bg-light{% endif %}">
                    {{ reply.message|linebreaks }}
                </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}

        <!-- Reply Form -->
        <div class="mt-5 pt-4 border-top">
            <h5 class="mb-3"><i class="bi bi-reply me-2 text-primary"></i>Reply</h5>
            <form method="post" class="reply-form">
                {% csrf_token %}
                <div class="mb-3">
                    {{ form.message }}
                    {% if form.message.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.message.errors|join:", " }}
                    </div>
                    {% endif %}
                </div>
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-brand">
                        <i class="bi bi-send me-1"></i>Send Reply
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
